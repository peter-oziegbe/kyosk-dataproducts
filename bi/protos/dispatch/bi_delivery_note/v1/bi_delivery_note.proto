syntax = "proto3";

package dispatch.bi_delivery_note.v1;

import "google/type/date.proto";
import "google/protobuf/timestamp.proto";
import "common/audit/v1/status_change.proto";

enum BiDNStatus{
  // DN initial status
  CREATED = 0;

  // DN is in a trip that is yet to be pulished
  SCHEDULED = 3; 
  
  // Associated DT has been published
  PUBLISHED = 4; //TODO: Confirm the published status is still relevant
  
  // this happens with a DN in published status is removed from a DT. Same level  as Created
  CHANGE_REQUESTED = 6;
  
  // The DT has been dispatched
  DISPATCHED = 7;
  
  // Goods have been Delivered to customer  
  DELIVERED = 9;
  
  // Goods have been paid for (Terminal State)
  PAID = 10;
  
  // DN has been rescheduled (Terminal State)
  RESCHEDULED = 12;
  
  // DN has been cacelled by driver (Terminal State)
  DRIVER_CANCELLED = 13;
  
  // DN has statedy in created without scheduling for too long (Terminal State)
  EXPIRED = 14;
}

message BiDeliveryNote {

  string id = 1;
  
  string code = 2;

  bool is_reschedule = 3;

  string reschedule_from_dn_id = 4;
  
  string sale_order_id = 5;

  string delivery_trip_id = 7;
  string driver_id = 8;

  string delivery_window_id  = 9;

  google.type.Date delivery_date = 10 ;

  // Id of outlet making the sales order
  string outlet_id = 11;
  // Id of retailer making the sales order
  string retailer_id = 12;

  string fullfilment_center_id = 13;

  string territory_id = 14;

  // This is the amount when the DN was created
  double original_amount = 15;

  // This is the amount with all modifications to the DN
  double amount = 16;

  BiDNStatus status = 17;

  repeated BiDnOrderCatalogItem order_items = 18;

  string payment_request_id = 19;
  
  bool is_pre_karuru = 20;
  repeated common.audit.v1.StatusChange status_change_history = 30;
  
  // enrichhed data products by Rodgers
  BiCompany company = 21;
  BiTerritory territory = 22;
  BiLocation location = 23;
  BiDeliveryWindow delivery_window = 24;
  BiOutlet outlet = 25;
  BiDriver driver = 26;
  BiVehicle vehicle = 27;
  BiServiceProvider service_provider = 28;
  BiDeliveryTrip delivery_trip = 29;
}

// Represents an order item
message BiDnOrderCatalogItem {
  string catalog_item_id = 1;
  
  string product_bundle_id = 2;
  
  // This is the quantity the DN was created with
  int32 original_item_qty = 3;
  
  // This start the same as the original qty but can change if decreased
  int32 catalog_item_qty = 4;

  // This is what is deliverd to the customer
  int32 qty_delivered = 5;

  double selling_price = 6;
  
  double discount_amount = 7;
  
  // total before discount <whether it includes VAT ??>
  double total_orderd = 8;
  // Total after discount <does it include VAT ??>
  double net_total_ordered = 9;

    // total before discount
  double total_delivered = 10;
  // Total after discount
  double net_total_delivered= 11;
  
  // This is a reference to the CatalogStockItem in Catalog
  repeated BiDnInventoryItem inventory_items = 12;
  
  BiItemStatus status = 13;

  string cancellation_reason = 14;

  // enriched data product for BI Reporting
  BiItemGroup item_group = 15;
}

message BiDnInventoryItem {
  string stock_item_id = 1;
  int32 conversion_factor = 2;
  int32 inventory_item_qty = 3;
}

enum BiItemStatus {
  
  // Immediately the DN has been created;
  ITEM_PENDING = 0;

  ITEM_DISPATCHED = 2;
  
  ITEM_RESCHEDULED = 4;
  
  ITEM_CANCELLED = 5;
  
  ITEM_FULFILLED = 6;
  
  // This marks an item as having been in a delivery note but subsequently removed before dispatch
  ITEM_REMOVED = 7;
}

// defines Item Group per item
message BiItemGroup {
  string id = 1;
  string name = 2;
}

// company details for contry reporting
message BiCompany {
  string id = 1;
  string company_name = 2;
}

// territories details
message BiTerritory {
  //unique identifier of territory in ERPNext and is similar to territory_name
  string id = 1;
  //Name of the territory. Is unique
  string territory_name = 2;
  //unique code for the territory
  string territory_code = 3;
  }

// delivery location 
message BiLocation {
  string name = 1;
  string latitude = 2;
  string longitude = 3;
}

message BiDeliveryWindow{
    // delivery window id
    string id = 1;
    //start time of delivery window in the format 'HH:mm:ss'
    string start_time = 2;
    //end time of delivery window in the format 'HH:mm:ss'
    string end_time = 3;
    }

message BiOutlet{
    // outlet phone number
    string phone_number = 1;
    // outlet code
    string outlet_code = 2;
}
message BiDriver{
    // driver id
    string id = 1;
    // driver name
    string name = 2;
    // driver phone number
    string phone_number = 3;
    // driver agency
    string service_provider_id = 4;
}
message BiVehicle{
    // vehicle id
    string id = 1;
    // vehicle licence plate
    string license_plate = 2;
    // vehicle service provide
    string service_provider_id = 3;
    // vehicle code
    string code = 4;
}

message BiServiceProvider{
    //  service provide id
    string id = 1;
    // service provider name
    string name = 2;
    // service provider type
    string provider_type = 3;
}

message BiDeliveryTrip{
    //The delivery trip code of the Delivery Note
	string id = 1;
    // delivery trip name/code
    string name = 2;
    //The driver code attached to the delivery trip
	string driver_id = 3;
    // datetime the Trip was created
    google.protobuf.Timestamp creation_date = 4;
}